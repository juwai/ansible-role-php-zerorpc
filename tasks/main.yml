---
- name: ensure php msgpack extension is installed
  shell: yes '' | pecl install msgpack-{{ pecl_msgpack_version }}
  register: pecl_msgpack_result
  changed_when: "'installed' not in pecl_msgpack_result.stdout"
  failed_when: "'ERROR' in pecl_msgpack_result.stdout"
  when: php_version == 'php5'

- name: ensure php zmq extension is installed
  shell: yes '' | pecl install zmq-{{ pecl_zmq_version }}
  register: pecl_zmq_result
  changed_when: "'installed' not in pecl_zmq_result.stdout"
  failed_when: "'ERROR' in pecl_zmq_result.stdout"
  when: php_version == 'php5'

- name: git clone zmq repo
  git:
    repo: "{{ zmq_source_repo }}"
    dest: "/tmp/php-zmq"
    version: "master"
  when: php_version == 'php7'

- name: install php-zmq 1.1.3
  shell: phpize && ./configure && make && make install
  args:
    chdir: /tmp/php-zmq
  when: php_version == 'php7'

- name: git clone msgpack repo
  git:
    repo: https://github.com/msgpack/msgpack-php.git
    dest: "/tmp/php-msgpack"
    version: "msgpack-2.0.2"
  when: php_version == 'php7'

- name: install php-msgpack 1.1.3
  shell: phpize && ./configure && make && make install
  args:
    chdir: /tmp/php-msgpack
  when: php_version == 'php7'

- name: ensure zmq and msgpack extension present in php.d/*.ini
  template:
    src: package.ini.j2
    dest: "/etc/php.d/{{ item }}.ini"
  with_items:
    - zmq
    - msgpack
  notify: restart php-fpm
